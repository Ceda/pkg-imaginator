"use strict";var ImaginatorCreate={init:function(){return this.el=document.querySelector(".imaginator-create"),this.option=$(".imaginator-create__option"),this.bindClickEvents["delete"]($("[data-delete-item]")),$(".tooltip").popup(),$(".ui.dropdown").dropdown(),this.el?(this.vue=new Vue(this.vueOptions()),this.isInited=!0,!0):!1},vueOptions:function(){return{el:".imaginator-create",data:{template:this.templateFromPHP,variations:this.variationsFromPHP,imaginator:this.imaginatorFromPHP,imaginatorSources:this.sourcesFromPHP,numberOfShownThumbnails:0,isLoading:!1,isSelected:!1,appUrl:IMAGINATOR.appUrl,firstLoaded:!1,isSaving:!1},mounted:function(){var i=this;this.$nextTick(function(){i.$dropzone=$(".imaginator-create__dropzone"),i.setDropzone(),i.imaginator.imaginator_template_id=i.template.id,i.imaginatorSources.length<1&&(i.imaginatorSources=[]),i.onLoadHandler(),i.waitForShowThumbnailsOnLoad()}),_.each(this.variations,function(t,e){i.hasSource(t)||i.$set(t,"isSelected",!0),i.$set(t,"isResizing",!1)})},methods:{selectVariation:function(i,t){var e=this;if(t){if(i.isResizing)return t&&t.target.classList.contains("cr-overlay")||t.target.classList.contains("cr-slider")?!1:(alert("Dokončete ořezávání"),!1);this.$nextTick(function(){if(!e.hasSomeWithoutSources&&!e.hasAllWithoutSources){var t=_.find(e.variations,{id:i.id});e.$set(t,"isSelected",!t.isSelected)}})}else{if(i.isResizing)return alert("Dokončete ořezávání"),!1;var n=_.find(this.variations,{id:i.id});this.$set(n,"isSelected",!n.isSelected)}},selectAllVariations:function(){var i=this;this.variations.forEach(function(t){i.$set(t,"isSelected",!0)})},deselectAllVariations:function(){var i=this;this.variations.forEach(function(t){return t.isResizing&&i.hasAllSources?!1:void i.$set(t,"isSelected",!1)})},selectVariationsWithoutSource:function(){var i=this,t=_.map(this.variations,"id"),e=_.map(this.imaginatorSources,"imaginator_variation_id"),n=_.difference(t,e);_.forEach(n,function(t){i.selectVariation(_.find(i.variations,{id:parseInt(t)})),i.$set(_.find(i.variations,{id:parseInt(t)}),"hasNoSource",!0)})},onLoadHandler:function(){var i=this;this.firstLoaded?this.hasSomeWithoutSources||(this.isSomethingResized||this.selectAllVariations(),this.variations.forEach(function(t){i.$set(t,"hasNoSource",!1)})):(this.hasAllSources?this.selectAllVariations():this.hasSomeWithoutSources?this.selectVariationsWithoutSource():this.hasAllWithoutSources&&this.isEditing&&(this.selectAllVariations(),this.variations.forEach(function(t){i.$set(t,"hasNoSource",!0)})),this.firstLoaded=!0)},setDropzone:function(){var i=this,t=this.$dropzone.data("url");this.dz=this.$dropzone.dropzone({url:t,maxFiles:1,acceptedFiles:"image/jpeg,image/png",sending:function(t,e,n){i.hasAllSources?n.append("variations",JSON.stringify(_.filter(i.variations,{isSelected:!0}))):n.append("variations",JSON.stringify(i.variations)),n.append("_token",IMAGINATOR.csrf_token),i.isLoading=!0,0!==i.numberOfShownThumbnails&&(i.numberOfShownThumbnails=0)},success:function(t,e){i.setSource(e),Dropzone.forElement(".imaginator-create__dropzone").destroy(),i.setDropzone(),i.$nextTick(function(){i.onLoadHandler(),i.setAllSelectedCroppies(),i.isLoading=!1}),i.waitForShowThumbnailsOnLoad()}}),Dropzone.forElement(".imaginator-create__dropzone").on("addedfile",function(){return i.hasAllSources&&!i.isSomethingSelected?(alert("Vyberte alespoň jednu možnost"),!1):void 0})},waitForShowThumbnailsOnLoad:function(){var i=this;_.forEach(this.variations,function(t){i.$nextTick(function(){var e=$(".image-to-crop--"+t.id);e.length&&(e[0].complete?i.numberOfShownThumbnails++:(e.unbind("load"),e.on("load",function(){i.numberOfShownThumbnails++,i.$nextTick(function(){e.unbind("load")})})))})})},waitForShowThumbnailOnResize:function(i){var t=this;this.$nextTick(function(){var e=$(".image-to-crop--"+i.id);e[0].complete?t.$set(i,"isResizeLoading",!1):(e.unbind("load"),t.$set(i,"isResizeLoading",!0),e.on("load",function(){t.$nextTick(function(){t.$set(i,"isResizeLoading",!1),e.unbind("load")})}))})},sendFile:function(){var i=this;window.sendFileRequest&&window.sendFileRequest.abort(),this.isSaving=!0,this.$set(this.imaginator,"imaginator_sources",this.imaginatorSources),window.sendFileRequest=$.ajax({type:"POST",url:IMAGINATOR.storeUrl,dataType:"json",data:{_token:IMAGINATOR.csrf_token,imaginator:this.imaginator},success:function(t){i.isSaving=!1,i.imaginator=t.imaginator,i.imaginatorSources=t.imaginatorSources,"undefined"!=typeof window.parent.swal&&(window.parent.lightboxResult=i.imaginator.id,window.parent.swal.clickCancel())},error:function(i){return 0===i.status?!1:void console.log(i)}})},hasSource:function(i){return"undefined"!=typeof i.source},setSource:function(i){var t=this;_.forEach(i.imaginatorSources,function(i){var e={},n=_.find(t.imaginatorSources,{imaginator_variation_id:i.imaginator_variation_id});n?n.source=i.source:(e.imaginator_variation_id=i.imaginator_variation_id,e.source=i.source,t.imaginatorSources.push(e))})},sourceToShow:function(i){var t=_.find(this.imaginatorSources,{imaginator_variation_id:i.id});return t?t.resized?-1!==t.resized.indexOf("base64")?t.resized:this.appUrl+"/"+t.resized:this.appUrl+"/"+t.source:!1},triggerOpenDropzone:function(){$(".imaginator-create__dropzone").trigger("click")},setAllCroppies:function(){var i=this;_.forEach(this.variations,function(t){i.setCroppie(t)})},setAllSelectedCroppies:function(){var i=this;_.forEach(this.variations,function(t){t.isSelected&&i.setCroppie(t)})},setCroppie:function(i,t){var e=this;Dropzone.forElement(".imaginator-create__dropzone").removeEventListeners(),this.$set(i,"isResizing",!0),this.$set(i,"isResizeLoading",!1);var n=$(".imaginator-create__thumbnail-item-image"),o=$(".image-to-crop--"+i.id),a=_.find(this.imaginatorSources,{imaginator_variation_id:i.id});a&&(o.attr("src",this.appUrl+"/"+a.source),t&&this.$nextTick(function(){e.waitForShowThumbnailOnResize(i)}));var s=i.width/i.height,r=n.width()/n.height(),u=n.width(),c=n.height(),h=null;h=i.width>=i.height?r>=s?{width:c*s,height:c}:{width:u,height:u/s}:r>=s?{width:c*s,height:c}:{width:u,height:u/s},i.crop=o.croppie({type:"canvas",viewport:h,enableExif:!0})},getCroppedImage:function(i){var t=this;if(this.$set(i,"isResizeLoading",!0),!i.isResizeLoading)return!1;var e=$(".thumbnail-image--"+i.id),n=i.crop;this.$nextTick(function(){setTimeout(function(){n.croppie("result",{type:"base64",size:{width:i.width,height:i.height}}).then(function(o){var a=_.find(t.imaginatorSources,{imaginator_variation_id:i.id});t.$set(a,"resized",o),n.croppie("destroy"),e.empty(),setTimeout(function(){e.append('<img src="'+a.resized+'" class="image-to-crop--'+i.id+'" alt="">'),setTimeout(function(){t.$set(i,"isResizeLoading",!1)})}),i.isResizing=!1,t.isSomethingResizing||Dropzone.forElement(".imaginator-create__dropzone").setupEventListeners()})},50)})},getAllCroppedImages:function(){var i=this,t=_.filter(this.variations,{isResizing:!0});t.forEach(function(t){i.getCroppedImage(t)})}},computed:{hasAllSources:function(){var i=this,t=_.map(this.variations,function(t){var e=_.find(i.imaginatorSources,{imaginator_variation_id:t.id});return e?null!==e.source&&e.source.length>0:!1});return-1===t.indexOf(!1)},hasSomeWithoutSources:function(){return this.variations.length>this.imaginatorSources.length&&0!==this.imaginatorSources.length},hasAllWithoutSources:function(){return 0===this.imaginatorSources.length},hasAllSourcesOrImaginatorHasId:function(){return this.hasAllSources||this.imaginator.id},isSelectedMultiple:function(){return this.numberOfSelected>1},isSomethingSelected:function(){return this.numberOfSelected>0},numberOfSelected:function(){return _.filter(this.variations,function(i){return i.isSelected}).length},numberOfResizing:function(){return _.filter(this.variations,function(i){return i.isResizing}).length},numberOfResized:function(){return _.filter(this.imaginatorSources,function(i){return i.resized}).length},isSomethingResized:function(){return this.numberOfResized>0},isAllResized:function(){return this.numberOfResized===this.variations.length&&0!==this.numberOfResized},isSomethingResizing:function(){return this.numberOfResizing>0},isEditing:function(){return"undefined"!=typeof this.imaginator.created_at&&null!==this.imaginator.created_at},thumbnailDimensions:function(){var i=null,t=null;return this.variations.length>2?(i=this.variations.length%2!==0?100/(this.variations.length+1)*2:100/this.variations.length*2,t="50%"):(i=100/this.variations.length,t="100%"),{height:i+"%",width:t}},allThumbnailsShown:function(){return this.numberOfShownThumbnails===this.variations.length}}}},bindClickEvents:{"delete":function(i){var t=$("#deleteName",".modal"),e=$("#deleteConfirm",".modal");i.on("click",function(){var i=$(this).parents("form");$("#deleteModal").modal("show"),t.html(i.data("delete-name")),e.on("click",function(){i.submit()})})}}};